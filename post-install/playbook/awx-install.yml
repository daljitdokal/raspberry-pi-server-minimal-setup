---
- name: Install AWX
  hosts: k3s_cluster
  gather_facts: false
  tasks:
    - name: Create variables
      set_fact:
        get_awx_namespace: "awx"

    - name: Download awx-operator from github
      ansible.builtin.git:
        repo: https://github.com/ansible/awx-operator.git
        dest: ~/Downloads

    - name: Create new namespace
      shell: |
        k3s kubectl create namespace {{ get_awx_namespace }} --dry-run=client -o yaml | k3s kubectl apply -f -
      become: true

    - name: Deploy awx-operator
      shell: |
        cd ~/Downloads
        export RELEASE_TAG=`curl -s https://api.github.com/repos/ansible/awx-operator/releases/latest | grep tag_name | cut -d '"' -f 4`
        git checkout $RELEASE_TAG
        # export getString="sed 's\/x86_64\/amd64\/')"
        # export setString="sed '-e 's\/x86_64\/amd64\/' -e 's\/aarch64\/arm64\/')"
        # sed -i "s/$getString/$setString/i" Makefile
        export NAMESPACE={{ get_awx_namespace }}
        make deploy

    - name: Create instance of awx
      shell: |
        k3s kubectl apply -f ../custom-config/awx.yml
      become: true
